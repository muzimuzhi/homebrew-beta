# based on https://github.com/TeX-Live/setup-texlive-action/blob/main/.github/workflows/dependabot.yml
name: Pull Request Labeler

on:
  workflow_run:
    workflows: ['brew test-bot']
    types: [completed]

permissions:
  contents: read
  pull-requests: write

jobs:
  labeler:
    runs-on: ubuntu-slim
    # https://docs.github.com/en/webhooks/webhook-events-and-payloads?actionType=requested#workflow_run
    # when action type is "requested", the `pull_requests[0].body` doesn't exist
    if: |
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Add label
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          PR: ${{ github.event.workflow_run.pull_requests[0].number }}
        run: |
          # Silence lint error about backtick usage inside single quotes.
          # shellcheck disable=SC2016
          if gh pr view "$PR" --json body \
                --jq '.body | contains("Created with `brew bump-cask-pr`.") or contains("Created with `brew bump-formula-pr`.")' > /dev/null; then
              echo "Adding label 'pr-pull' to PR #$PR"
              gh pr edit "$PR" --add-label "pr-pull"
          else
              echo "No label added"
              gh pr view "$PR" --json body
          fi
